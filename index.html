<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>RUNNING MILEAGE ANIMATION MAKER</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>

  <!-- Google Fonts: 9종 (기본 Anton) -->
  <link href="https://fonts.googleapis.com/css2?family=Anton:wght@400&family=Orbitron:wght@700&family=Fugaz+One&family=Special+Gothic+Expanded+One&family=Notable&family=Monoton&family=Permanent+Marker&family=Lobster&family=Rock+Salt&display=swap" rel="stylesheet">

  <style>
    :root{ --pad:16px; --maxw:480px; --ui-gap:10px; }
    *{box-sizing:border-box}
    html,body{margin:0; background:#fff; color:#000; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;}

    header{ padding:14px var(--pad) 6px; text-align:left; }
    h1{ margin:0 0 4px; font-size:18px; font-weight:800; }
    .subtitle{ font-size:12px; opacity:.85 }

    .wrap{ width:100%; max-width:var(--maxw); margin:0 auto; padding:0 var(--pad); }
    .section{ margin:14px 0; }

    .upload-box{ border:1px solid #e5e5e5; border-radius:10px; padding:14px; }
    .upload-label{ display:block; background:#000; color:#fff; padding:12px 14px; font-weight:800; border-radius:8px; text-align:center; }
    .status{ color:#16a34a; font-weight:700; font-size:13px; margin-top:8px; }

    .control-title{ font-size:13px; font-weight:800; margin:12px 0 8px; }
    .font-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:var(--ui-gap); }
    .font-grid button,.bg-row button,.run-button{
      width:100%; height:44px; border-radius:10px; border:2px solid #000;
      background:#fff; color:#000; font-size:14px; font-weight:700;
    }
    .bg-row{ display:grid; grid-template-columns:repeat(2,1fr); gap:var(--ui-gap); }
    .run-button{ background:#000; color:#7fff00; border-color:#0070ff; margin-top:6px; }

    /* ======= Stage ======= */
    .stage{ width:100%; max-width:var(--maxw); margin:10px auto 24px; padding:0 var(--pad); }

    .km-line{ display:flex; align-items:baseline; column-gap:10px; }
    /* 좌측 고정 + 99.99 기준 폭 계산을 위해 실제 글자 사이즈로 조정 */
    #km{ font-family:'Anton', sans-serif; font-weight:400; line-height:1; white-space:nowrap; }
    #km-unit{ line-height:1; white-space:nowrap; opacity:0; transition:opacity 400ms ease; }

    /* 하단: Avg. Pace / Time 두 칼럼만 */
    .stats{ margin-top:14px; display:grid; grid-template-columns:1fr 1fr; gap:14px; text-align:left; }
    .stat-val{ font-size:28px; font-weight:800; }
    .stat-lab{ font-size:14px; font-weight:700; opacity:.9; }

    /* 포커스 모드: UI 숨기고 스테이지만 */
    body.focus .top-ui{ display:none; }
    #exit-focus{ display:none; position:fixed; z-index:30; top:env(safe-area-inset-top,8px); right:10px; width:40px; height:40px; border-radius:20px; border:2px solid #000; background:#fff; font-weight:800; }
    body.focus #exit-focus{ display:block; }

    .bg-black{ background:#000; color:#fff; }
    .bg-white{ background:#fff; color:#000; }
  </style>
</head>
<body class="bg-white">
  <header class="wrap">
    <h1>RUNNING MILEAGE ANIMATION MAKER</h1>
    <div class="subtitle">by JS @runarchive.js</div>
  </header>

  <!-- 설정 UI (모바일 우선) -->
  <div class="top-ui">
    <div class="wrap">
      <section class="section upload-box">
        <label for="file-upload" class="upload-label">기록 이미지 업로드</label>
        <input type="file" id="file-upload" accept="image/*" style="display:none;" />
        <div class="status" id="upload-status"></div>
      </section>

      <section class="section">
        <div class="control-title">Font</div>
        <div class="font-grid">
          <button style="font-family:'Anton'"               onclick="setFont('Anton')">Anton</button>
          <button style="font-family:'Orbitron',sans-serif" onclick="setFont('Orbitron')">Orbitron</button>
          <button style="font-family:'Fugaz One'"           onclick="setFont('Fugaz One')">Fugaz One</button>
          <button style="font-family:'Special Gothic Expanded One'" onclick="setFont('Special Gothic Expanded One')">Special Gothic</button>
          <button style="font-family:'Notable'"             onclick="setFont('Notable')">Notable</button>
          <button style="font-family:'Monoton'"             onclick="setFont('Monoton')">Monoton</button>
          <button style="font-family:'Permanent Marker'"    onclick="setFont('Permanent Marker')">Permanent Marker</button>
          <button style="font-family:'Lobster'"             onclick="setFont('Lobster')">Lobster</button>
          <button style="font-family:'Rock Salt'"           onclick="setFont('Rock Salt')">Rock Salt</button>
        </div>
      </section>

      <section class="section">
        <div class="control-title">Background</div>
        <div class="bg-row">
          <button onclick="setBackground('black')">Black</button>
          <button onclick="setBackground('white')">White</button>
        </div>
      </section>

      <section class="section">
        <button class="run-button" id="run-btn" onclick="onRun()">RUN</button>
      </section>
    </div>
  </div>

  <button id="exit-focus" title="Close" onclick="exitFocus()">✕</button>

  <!-- ======= Stage ======= -->
  <main class="stage" id="stage">
    <div class="km-line">
      <span id="km">0.00</span>
      <span id="km-unit">km</span>
    </div>

    <div class="stats">
      <div>
        <div class="stat-val" id="pace">—</div>
        <div class="stat-lab">Avg. Pace</div>
      </div>
      <div>
        <div class="stat-val" id="time">—</div>
        <div class="stat-lab">Time</div>
      </div>
    </div>
  </main>

  <script>
    let parsed = { km:null, pace:null, time:null };
    const kmEl = document.getElementById('km');
    const unitEl = document.getElementById('km-unit');
    const stage = document.getElementById('stage');

    // -------- OCR 파싱 (시간: 59:26 / 1:28:33 모두 허용, pace '--'도 허용) --------
    function normalizeTimeToken(str){
      const t = str.replace(/[^\d:]/g,'');
      if(/^\d{1,2}:\d{2}:\d{2}$/.test(t)) return t;              // H:MM:SS
      if(/^\d{1,2}:\d{2}$/.test(t)) return t;                    // M:SS
      return null;
    }
    function findTime(text){
      const tokens = text.split(/[\s\n]+/);
      for(const x of tokens){
        const n = normalizeTimeToken(x);
        if(n) return n;
      }
      return null;
    }
    function findPace(text){
      // 예: 5'54"  /  7'22''  /  --  (심박없는 경우 등)
      const m = text.match(/(\d{1,2})['′](\d{2})["″]?/);
      if(m) return `${m[1]}'${m[2]}"`;
      if(/(^|\s)--(\s|$)/.test(text)) return '—';
      return null;
    }
    function findKm(text){
      // 첫 소수(최대 2자리 소수) 탐색
      const m = text.match(/\b\d{1,2}\.\d{1,2}\b/);
      return m ? m[0] : null;
    }

    document.getElementById('file-upload').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      document.getElementById('upload-status').textContent = '업로드 완료';
      document.getElementById('run-btn').style.display = 'block';

      const rd = new FileReader();
      rd.onload = async () => {
        const { data:{ text } } = await Tesseract.recognize(rd.result,'eng');
        parsed.km   = findKm(text);
        parsed.time = findTime(text) || '—';
        parsed.pace = findPace(text) || '—';
      };
      rd.readAsDataURL(file);
    });

    // -------- 숫자 카운트업 (좌측 고정) --------
    const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
    function animateKm(from, to, duration=2000){
      return new Promise(resolve=>{
        let start; 
        function tick(now){
          if(!start) start = now;
          const p = Math.min((now-start)/duration,1);
          const v = (from + (to-from)*easeOutCubic(p)).toFixed(2);
          kmEl.textContent = v;
          if(p<1) requestAnimationFrame(tick); else resolve();
        }
        requestAnimationFrame(tick);
      });
    }

    // -------- 99.99 기준 글자 크기 산정 (좌측 고정, 화면 넘침 방지) --------
    function fitKmByBaseline(){
      const test = document.createElement('span');
      test.style.position='absolute';
      test.style.visibility='hidden';
      test.style.whiteSpace='nowrap';
      test.style.fontFamily = getComputedStyle(kmEl).fontFamily;
      test.style.fontWeight = getComputedStyle(kmEl).fontWeight;
      test.textContent = '99.99';
      document.body.appendChild(test);

      // 테스트 기본 크기
      test.style.fontSize = '100px';
      const testWidth = test.getBoundingClientRect().width;

      // 목표 폭: 스테이지 내부(패딩 포함) 폭의 약 92%
      const stageW = stage.getBoundingClientRect().width;
      const target = stageW * 0.92;

      const fontSize = Math.floor((target / testWidth) * 100);
      kmEl.style.fontSize = fontSize + 'px';
      unitEl.style.fontSize = Math.round(fontSize * 0.35) + 'px';

      document.body.removeChild(test);
    }

    async function run(){
      unitEl.style.opacity = 0;
      fitKmByBaseline();

      const end = parseFloat(parsed.km||0) || 0;
      await animateKm(0, end, 2200);
      unitEl.style.opacity = 1;

      document.getElementById('pace').textContent = parsed.pace || '—';
      document.getElementById('time').textContent = parsed.time || '—';
    }

    // -------- Actions --------
    function onRun(){
      document.body.classList.add('focus');
      stage.scrollIntoView({behavior:'smooth', block:'start'});
      run();
    }
    function exitFocus(){
      document.body.classList.remove('focus');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function setFont(fontName){
      kmEl.style.fontFamily = `'${fontName}', sans-serif`;
      unitEl.style.fontFamily = `'${fontName}', sans-serif`;
      fitKmByBaseline();
    }
    function setBackground(color){
      const b = document.body;
      if(color==='black'){ b.classList.remove('bg-white'); b.classList.add('bg-black'); }
      else { b.classList.remove('bg-black'); b.classList.add('bg-white'); }
    }

    window.addEventListener('resize', fitKmByBaseline);
    window.addEventListener('orientationchange', ()=> setTimeout(fitKmByBaseline, 120));
    window.onload = ()=> { setFont('Anton'); fitKmByBaseline(); };
  </script>
</body>
</html>
