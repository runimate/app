<!DOCTYPE html>
<html lang="ko" class="bg-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>RUNIMATE</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Anton:wght@400&family=Big+Shoulders+Inline+Text:wght@800&family=Alfa+Slab+One&family=Orbitron:wght@700&family=Special+Gothic+Expanded+One&family=Graduate&family=Gloria+Hallelujah&family=Rock+Salt&display=swap" rel="stylesheet">

  <style>
    :root{
      --pad:16px;
      --maxw:480px;
      --gapBelowKm: 12px;
      --radius:14px;
      --kmWordSize: 28px;
      --kmWordGap: 0px;
    }
    body {
      font-family: 'Anton', sans-serif;
      padding: var(--pad);
      max-width: var(--maxw);
      margin: auto;
      background: white;
    }
    #output {
      margin-top: 20px;
      text-align: center;
    }
    #distance {
      font-size: 48px;
    }
    #unit, #runs, #pace, #time {
      font-size: 20px;
      margin-top: var(--gapBelowKm);
    }
  </style>
</head>
<body>
  <input type="file" id="file-upload" />
  <div id="output">
    <div><span id="distance"></span> <span id="unit"></span></div>
    <div id="runs"></div>
    <div id="pace"></div>
    <div id="time"></div>
  </div>
    <script>
    document.getElementById("file-upload").addEventListener("change", async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async () => {
        const { data: { text } } = await Tesseract.recognize(reader.result, 'eng');
        const textLower = text.toLowerCase();
        const recordType = textLower.includes("monthly") ? "monthly" : "daily";

        const ocrKmRaw = parseFloat((textLower.match(/[0-9]+(\.[0-9]+)?\s?km/) || [""])[0]);
        const hasOCRkm = isFinite(ocrKmRaw);

        const finalRuns = parseInt((textLower.match(/\d+\s?runs?/) || [""])[0]) || 0;
        const timeStr = (textLower.match(/time\s+\d{1,2}:\d{2}:\d{2}/) || [""])[0].split(" ")[1] || "";
        const paceStr = (textLower.match(/avg pace\s+\d{1,2}:\d{2}/) || [""])[0].split(" ")[2] || "";

        const parseTime = (str) => {
          const parts = str.split(":").map(Number);
          return parts.reduce((acc, cur, i) => acc * 60 + cur, 0);
        };

        const finalTimeSec = timeStr ? parseTime(timeStr) : NaN;
        const finalTimeHour = timeStr ? parseInt(timeStr.split(":")[0]) : NaN;
        const finalTimeMin = timeStr ? parseInt(timeStr.split(":")[1]) : NaN;
        const finalTimeSecOnly = timeStr ? parseInt(timeStr.split(":")[2]) : NaN;

        const paceParts = paceStr.split(":");
        const finalPaceMin = paceParts.length === 2 ? parseInt(paceParts[0]) : NaN;
        const finalPaceSec = paceParts.length === 2 ? parseInt(paceParts[1]) : NaN;

        // ✅ 데일리일 경우 계산하지 않고 OCR 값만 사용
        let finalKm;
        if (recordType === 'daily') {
          finalKm = hasOCRkm ? ocrKmRaw : 0;
        } else {
          const paceSec = finalPaceMin * 60 + finalPaceSec;
          const calcKm = (isFinite(finalTimeSec) && isFinite(paceSec) && paceSec > 0) ? finalTimeSec / paceSec : NaN;

          if (hasOCRkm && ocrKmRaw >= 0.8 && ocrKmRaw <= 200){
            finalKm = ocrKmRaw;
            if (isFinite(calcKm) && Math.abs(calcKm - ocrKmRaw) >= 3){
              finalKm = calcKm;
            }
            if (isFinite(calcKm) && calcKm < 1){
              finalKm = ocrKmRaw;
            }
          } else if (!hasOCRkm && isFinite(calcKm)) {
            finalKm = calcKm;
          } else {
            finalKm = 0;
          }
        }
                const parsedData = {
          distance: finalKm,
          runs: finalRuns,
          paceMin: finalPaceMin,
          paceSec: finalPaceSec,
          timeHour: finalTimeHour,
          timeMin: finalTimeMin,
          timeSec: finalTimeSecOnly
        };

        renderOutput(parsedData, "Anton", "center");
      };
      reader.readAsDataURL(file);
    });

    function renderOutput(data, font, align) {
      document.getElementById("distance").textContent = data.distance.toFixed(1);
      document.getElementById("unit").textContent = "KM";
      document.getElementById("runs").textContent = data.runs ? `${data.runs} Runs` : "";
      document.getElementById("pace").textContent = isFinite(data.paceMin) ? `Avg Pace ${data.paceMin}:${data.paceSec.toString().padStart(2, "0")}` : "";
      document.getElementById("time").textContent = isFinite(data.timeMin) ? `Time ${data.timeHour}:${data.timeMin.toString().padStart(2, "0")}:${data.timeSec.toString().padStart(2, "0")}` : "";
    }
  </script>
</body>
</html>
